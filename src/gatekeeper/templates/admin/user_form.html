{% extends "base.html" %}
{% block title %}{{ "Edit User" if user else "Create User" }} - Gatekeeper{% endblock %}

{% block content %}
<h1>{% if user %}Edit User: {{ user.username }}{% else %}Create User{% endif %}</h1>

{% if user and is_ldap %}
<p><mark class="secondary">LDAP User ({{ user.ldap_domain }})</mark>
    <button class="outline" style="padding: 4px 8px; margin: 0 0 0 0.5rem;"
            hx-post="{{ url_for('admin_users.refresh_ldap', username=user.username) }}">Refresh from LDAP</button>
</p>
{% endif %}

{% set ldap_ro = user and is_ldap %}

<form method="post"
      action="{{ url_for('admin_users.edit_user', username=user.username) if user else url_for('admin_users.create_user') }}">
    <label for="username">
        Username
        <input type="text" id="username" name="username" required autofocus
               value="{{ user.username if user else '' }}"
               placeholder="e.g. DOMAIN\jsmith or jsmith"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="email">
        Email
        <input type="email" id="email" name="email" required
               value="{{ user.email if user else '' }}"
               placeholder="user@example.com"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="fullname">
        Full Name
        <input type="text" id="fullname" name="fullname"
               value="{{ user.fullname if user else '' }}"
               placeholder="Jane Smith"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="given_name">
        Given Name
        <input type="text" id="given_name" name="given_name"
               value="{{ user.given_name if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="mail_nickname">
        Mail Nickname
        <input type="text" id="mail_nickname" name="mail_nickname"
               value="{{ user.mail_nickname if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="title">
        Title
        <input type="text" id="title" name="title"
               value="{{ user.title if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="department">
        Department
        <input type="text" id="department" name="department"
               value="{{ user.department if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="manager">
        Manager
        <input type="text" id="manager" name="manager"
               value="{{ user.manager if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="telephone_number">
        Telephone Number
        <input type="text" id="telephone_number" name="telephone_number"
               value="{{ user.telephone_number if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <label for="mobile_number">
        Mobile Number
        <input type="text" id="mobile_number" name="mobile_number"
               value="{{ user.mobile_number if user else '' }}"
               {{ 'readonly aria-disabled="true"' if ldap_ro else '' }}>
    </label>

    <fieldset>
        <label>
            <input type="checkbox" name="enabled" role="switch"
                   {{ "checked" if (user.enabled if user else true) }}>
            Enabled
        </label>
    </fieldset>

    <div style="display: flex; gap: 1rem; align-items: center;">
        <button type="submit">{{ "Save" if user else "Create" }}</button>
        <button type="button" class="outline secondary" onclick="location.href='{{ url_for('admin_users.list_users') }}'">Cancel</button>
    </div>
</form>

{% if user %}
<hr>
<h2>Groups</h2>
<p>
    {% for grp in groups %}<mark style="margin-right: 0.25rem;">{{ grp }}</mark>{% else %}None{% endfor %}
</p>
<button type="button" class="outline" onclick="location.href='{{ url_for('admin_users.user_groups', username=user.username) }}'">Edit group memberships...</button>

<hr>
<h2>Properties</h2>
{% include "admin/user_properties_list.html" %}

<hr>
<h2>Delete user</h2>
<form method="post" action="{{ url_for('admin_users.delete_user', username=user.username) }}"
      onsubmit="return confirm('Permanently delete user \'{{ user.username }}\'? This cannot be undone.');">
    <button type="submit" class="secondary">Delete User</button>
</form>
{% endif %}
{% endblock %}
