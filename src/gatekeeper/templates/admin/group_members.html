{% extends "base.html" %}
{% block title %}Members of {{ group.name }} - Gatekeeper{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/tom-select.min.css') }}">
{% endblock %}

{% block content %}
<h1>Members of: {{ group.name }}</h1>

{% if group.source == 'ldap' %}
<p><mark class="secondary">LDAP group</mark> â€” membership is managed by LDAP.</p>
{% else %}
<form hx-post="{{ url_for('admin_groups.add_member', name=group.name) }}"
      hx-target="#members-list"
      hx-swap="innerHTML"
      style="max-width: 500px;">
    <label for="add-member-select">
        Add member
        <select id="add-member-select" name="username" required placeholder="Select user to add to {{ group.name }}..."></select>
    </label>
    <button type="submit">Add</button>
</form>
{% endif %}

<div id="members-list">
    {% include "admin/group_members_list.html" %}
</div>

<button type="button" class="outline secondary" onclick="location.href='{{ url_for('admin_groups.list_groups') }}'">Back to Groups</button>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='vendor/tom-select.min.js') }}"></script>
{% if group.source != 'ldap' %}
<script>
(function() {
    var searchUrl = "{{ url_for('admin_groups.search_users') }}";

    var renderOption = function(data, escape) {
        var label = escape(data.text);
        var extra = [];
        if (data.fullname) extra.push(escape(data.fullname));
        if (data.email && data.email !== data.text) extra.push(escape(data.email));
        if (extra.length) {
            label += '<small class="user-email"> (' + extra.join(' - ') + ')</small>';
        }
        return '<div>' + label + '</div>';
    };

    var renderItem = function(data, escape) {
        return '<div>' + escape(data.text) + '</div>';
    };

    var addSelect = new TomSelect('#add-member-select', {
        valueField: 'value',
        labelField: 'text',
        searchField: ['text', 'email', 'fullname'],
        maxItems: 1,
        loadThrottle: 200,
        preload: 'focus',
        load: function(query, callback) {
            fetch(searchUrl + '?q=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(json) { callback(json); })
                .catch(function() { callback(); });
        },
        render: { option: renderOption, item: renderItem }
    });

    document.getElementById('members-list').addEventListener('htmx:afterSwap', function() {
        addSelect.clear();
    });
})();
</script>
{% endif %}
{% endblock %}
