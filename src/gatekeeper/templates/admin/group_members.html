{% extends "base.html" %}
{% block title %}Members of {{ group.name }} - Gatekeeper{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/tom-select.min.css') }}">
{% endblock %}

{% block content %}
<h1>Members of: {{ group.name }}</h1>

<form hx-post="{{ url_for('admin_groups.add_member', name=group.name) }}"
      hx-target="#members-list"
      hx-swap="innerHTML">
    <fieldset role="group">
        <select id="add-member-select" name="username" required placeholder="Search users..."></select>
        <button type="submit">Add</button>
    </fieldset>
</form>

<div id="members-list">
    {% include "admin/group_members_list.html" %}
</div>

<hr>

<h2>Copy memberships from user</h2>
<form method="post" style="max-width: 500px;">
    <label for="source_username">
        Source username
        <select id="source_username" name="source_username" required placeholder="Copy from this user..."></select>
    </label>
    <label for="target_username">
        Target username
        <select id="target_username" name="target_username" required placeholder="Copy to this user..."></select>
    </label>
    <button type="submit" formaction="" id="copy-btn">Copy</button>
</form>

<script>
document.getElementById("copy-btn").addEventListener("click", function(e) {
    var source = document.getElementById("source_username").value.trim();
    var target = document.getElementById("target_username").value.trim();
    if (!source || !target) return;
    this.closest("form").action = "{{ url_for('admin_groups.copy_memberships', name=group.name, source_username='__SRC__') }}".replace("__SRC__", encodeURIComponent(source));
});
</script>

<button type="button" class="outline secondary" onclick="location.href='{{ url_for('admin_groups.list_groups') }}'">Back to Groups</button>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='vendor/tom-select.min.js') }}"></script>
<script>
(function() {
    var searchUrl = "{{ url_for('admin_groups.search_users') }}";

    var renderOption = function(data, escape) {
        var label = escape(data.text);
        var extra = [];
        if (data.fullname) extra.push(escape(data.fullname));
        if (data.email && data.email !== data.text) extra.push(escape(data.email));
        if (extra.length) {
            label += '<small class="user-email"> (' + extra.join(' - ') + ')</small>';
        }
        return '<div>' + label + '</div>';
    };

    var renderItem = function(data, escape) {
        return '<div>' + escape(data.text) + '</div>';
    };

    function makeUserSelect(el) {
        return new TomSelect(el, {
            valueField: 'value',
            labelField: 'text',
            searchField: ['text', 'email', 'fullname'],
            maxItems: 1,
            loadThrottle: 200,
            preload: 'focus',
            load: function(query, callback) {
                fetch(searchUrl + '?q=' + encodeURIComponent(query))
                    .then(function(r) { return r.json(); })
                    .then(function(json) { callback(json); })
                    .catch(function() { callback(); });
            },
            render: { option: renderOption, item: renderItem }
        });
    }

    var addSelect = makeUserSelect('#add-member-select');
    makeUserSelect('#source_username');
    makeUserSelect('#target_username');

    // Clear the add-member select after HTMX swap so it's ready for the next add
    document.getElementById('members-list').addEventListener('htmx:afterSwap', function() {
        addSelect.clear();
    });
})();
</script>
{% endblock %}
